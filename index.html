<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ChatGPT local (HTML/CSS/JS)</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#0b1220;color:#e6eef6;margin:0;display:flex;align-items:center;justify-content:center;height:100vh}
  .box{width:100%;max-width:780px;background:#061022;border-radius:12px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  #chat{height:480px;overflow:auto;padding:12px;border-radius:8px;background:linear-gradient(0deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}
  .msg{padding:10px 12px;border-radius:10px;max-width:78%;margin:8px 0;white-space:pre-wrap}
  .user{background:#083048;color:#cceeff;margin-left:auto}
  .bot{background:#071427;color:#e6f6ff;margin-right:auto}
  footer{display:flex;gap:8px;margin-top:12px}
  input[type="text"]{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  button{padding:10px 12px;border-radius:8px;border:0;background:#7dd3fc;color:#012;cursor:pointer}
  .small{font-size:13px;color:#94a3b8}
</style>
</head>
<body>
  <div class="box" role="application" aria-label="Chat local">
    <header>
      <div>
        <h2 style="margin:0 0 4px 0">ChatGPT — local</h2>
        <div class="small">Mode : client local → utilise <code>config.js</code></div>
      </div>
      <div class="small">N'oublie pas : révoque la clé exposée</div>
    </header>

    <div id="chat" aria-live="polite"></div>

    <footer>
      <input id="input" type="text" placeholder="Écris ton message..." />
      <button id="send">Envoyer</button>
      <button id="clear" style="background:transparent;color:#7dd3fc;border:1px solid rgba(125,211,252,0.12)">Effacer</button>
    </footer>
  </div>

<script type="module">
/*
  IMPORTANT:
  - Crée le fichier config.js (même dossier) avec : export const OPENAI_KEY = "<TA_CLE_ICI>";
  - Lance un serveur local (ex: python -m http.server 8000) avant d'ouvrir index.html.
  - Ne mets pas la cle dans un dépôt public. Garde le fichier local.
*/

import { OPENAI_KEY } from './config.js';

const chatEl = document.getElementById('chat');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('send');
const clearBtn = document.getElementById('clear');

let conversation = [
  { role: "system", content: "Tu es une IA serviable, polie et concise." }
];

function addMessage(role, text) {
  const d = document.createElement('div');
  d.className = 'msg ' + (role === 'user' ? 'user' : 'bot');
  d.textContent = text;
  chatEl.appendChild(d);
  chatEl.scrollTop = chatEl.scrollHeight;
  return d;
}

async function sendToOpenAI(messages) {
  // Appel direct à OpenAI (côté client) — RISQUE D'EXPOSITION de la clé si tu partages
  const url = 'https://api.openai.com/v1/chat/completions';
  const payload = {
    model: "gpt-4o-mini", // adapte si nécessaire selon ton accès
    messages: messages,
    max_tokens: 800,
    temperature: 0.6
  };

  const resp = await fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + OPENAI_KEY
    },
    body: JSON.stringify(payload)
  });

  if (!resp.ok) {
    const txt = await resp.text();
    throw new Error('OpenAI error ' + resp.status + ': ' + txt);
  }
  const data = await resp.json();
  // lecture des formats courants
  return data?.choices?.[0]?.message?.content ?? data?.choices?.[0]?.text ?? JSON.stringify(data);
}

async function handleSend() {
  const text = inputEl.value.trim();
  if (!text) return;
  addMessage('user', text);
  inputEl.value = '';
  conversation.push({ role: 'user', content: text });

  const placeholder = addMessage('bot', '...');

  try {
    const reply = await sendToOpenAI(conversation);
    placeholder.textContent = reply;
    conversation.push({ role: 'assistant', content: reply });
  } catch (err) {
    console.error(err);
    placeholder.textContent = 'Erreur : ' + (err.message || err);
  }
}

sendBtn.addEventListener('click', handleSend);
inputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSend(); });
clearBtn.addEventListener('click', () => { chatEl.innerHTML = ''; conversation = [{ role: "system", content: "Tu es une IA serviable, polie et concise." }]; });

addMessage('bot', "Bienvenue — tape un message pour commencer.");
</script>
</body>
</html>
